function $(B){if(typeof B=="string"){return document.getElementById(B)}else{return B}}function clone(C){var D={};for(property in C){D[property]=C[property]}return D}function insertElement(G,J,H,K,I){var L=document.createElement(J);if(H){L.id=H}if(K){L.className=K}if(I){insertText(L,I)}if(G){G.appendChild(L)}return L}function insertText(C,D){return C.appendChild(document.createTextNode(D))}function removeChildren(B){while(B.hasChildNodes()){B.removeChild(B.firstChild)}}function setPageElement(E,F,D){if(place=$(E)){removeChildren(place);if(tale.has(F)){new Wikifier(place,tale.get(F).text)}else{new Wikifier(place,D)}}}function addStyle(D){if(document.createStyleSheet){document.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd","&nbsp;<style>"+D+"</style>")}else{var C=document.createElement("style");C.type="text/css";C.appendChild(document.createTextNode(D));document.getElementsByTagName("head")[0].appendChild(C)}}function throwError(C,D){new Wikifier(C,"'' @@ "+D+" @@ ''")}Math.easeInOut=function(B){return(1-((Math.cos(B*Math.PI)+1)/2))};String.prototype.readMacroParams=function(){var E=new RegExp("(?:\\s*)(?:(?:\"([^\"]*)\")|(?:'([^']*)')|(?:\\[\\[([^\\]]*)\\]\\])|([^\"'\\s]\\S*))","mg");var F=[];do{var D=E.exec(this);if(D){if(D[1]){F.push(D[1])}else{if(D[2]){F.push(D[2])}else{if(D[3]){F.push(D[3])}else{if(D[4]){F.push(D[4])}}}}}}while(D);return F};String.prototype.readBracketedList=function(){var L="\\[\\[([^\\]]+)\\]\\]";var G="[^\\s$]+";var I="(?:"+L+")|("+G+")";var J=new RegExp(I,"mg");var H=[];do{var K=J.exec(this);if(K){if(K[1]){H.push(K[1])}else{if(K[2]){H.push(K[2])}}}}while(K);return(H)};String.prototype.trim=function(){var B=new RegExp("^\\s*(.*?)\\s*$","mg");return(this.replace(B,"$1"))};Array.prototype.indexOf||(Array.prototype.indexOf=function(H,F){F=(F==null)?0:F;var E=this.length;for(var G=F;G<E;G++){if(this[G]==H){return G}}return -1});function fade(L,O){var J;var M=L.cloneNode(true);var K=(O.fade=="in")?1:-1;L.parentNode.replaceChild(M,L);if(O.fade=="in"){J=0;M.style.visibility="visible"}else{J=1}P(M,J);var I=window.setInterval(N,25);function N(){J+=0.05*K;P(M,Math.easeInOut(J));if(((K==1)&&(J>=1))||((K==-1)&&(J<=0))){L.style.visibility=(O.fade=="in")?"visible":"hidden";M.parentNode.replaceChild(L,M);delete M;window.clearInterval(I);if(O.onComplete){O.onComplete()}}}function P(B,C){var A=Math.floor(C*100);B.style.zoom=1;B.style.filter="alpha(opacity="+A+")";B.style.opacity=C}}function scrollWindowTo(T){var K=window.scrollY?window.scrollY:document.body.scrollTop;var R=O(T);var L=Math.abs(K-R);var M=0;var P=(K>R)?-1:1;var S=window.setInterval(Q,25);function Q(){M+=0.1;window.scrollTo(0,K+P*(L*Math.easeInOut(M)));if(M>=1){window.clearInterval(S)}}function O(E){var D=N(E);var C=D+E.offsetHeight;var B=window.scrollY?window.scrollY:document.body.scrollTop;var A=window.innerHeight?window.innerHeight:document.body.clientHeight;var F=B+A;if(D<B){return D}else{if(C>F){if(E.offsetHeight<A){return(D-(A-E.offsetHeight)+20)}else{return D}}else{return D}}}function N(B){var A=0;while(B.offsetParent){A+=B.offsetTop;B=B.offsetParent}return A}}function History(){this.history=[{passage:null,variables:{},hash:null}]}History.prototype.init=function(){var B=this;if(!this.restore()){this.display("Start",null)}this.hash=window.location.hash;this.interval=window.setInterval(function(){B.watchHash.apply(B)},250)};History.prototype.display=function(H,J,F){var I=tale.get(H);this.history.unshift({passage:I,variables:clone(this.history[0].variables)});this.history[0].hash=this.save();var G=I.render();if(F!="offscreen"){removeChildren($("passages"));$("passages").appendChild(G);if(F!="quietly"){fade(G,{fade:"in"})}}if((F=="quietly")||(F=="offscreen")){G.style.visibility="visible"}if(F!="offscreen"){document.title=tale.title;this.hash=this.save();if(I.title!="Start"){document.title+=": "+I.title;window.location.hash=this.hash}window.scroll(0,0)}return G};History.prototype.restart=function(){window.location.hash=""};History.prototype.save=function(E){var D="";for(var F=this.history.length-1;F>=0;F--){if((this.history[F].passage)&&(this.history[F].passage.id)){D+=this.history[F].passage.id.toString(36)+"."}}return"#"+D.substr(0,D.length-1)};History.prototype.restore=function(){try{if((window.location.hash=="")||(window.location.hash=="#")){return false}var G=window.location.hash.replace("#","").split(".");var K=[];for(var L=0;L<G.length;L++){var H=parseInt(G[L],36);if(!tale.has(H)){return false}var I=(L==G.length-1)?"":"offscreen";K.unshift(this.display(H,null,I))}return true}catch(J){return false}};History.prototype.watchHash=function(){if(window.location.hash!=this.hash){if((window.location.hash!="")&&(window.location.hash!="#")){this.history=[{passage:null,variables:{}}];removeChildren($("passages"));$("passages").style.visibility="hidden";if(!this.restore()){alert("The passage you had previously visited could not be found.")}$("passages").style.visibility="visible"}else{window.location.reload()}this.hash=window.location.hash}};var version={major:2,minor:0,revision:0,date:new Date("July 30, 2007"),extensions:{}};var tale,state;var macros={};function main(){tale=new Tale();document.title=tale.title;setPageElement("storyTitle","StoryTitle","Untitled Story");if(tale.has("StoryAuthor")){$("titleSeparator").innerHTML="<br />";setPageElement("storyAuthor","StoryAuthor","")}if(tale.has("StoryMenu")){$("storyMenu").style.display="block";setPageElement("storyMenu","StoryMenu","")}for(macro in macros){if(typeof macro.init=="function"){macro.init()}}var styles=tale.lookup("tags","stylesheet");for(var i=0;i<styles.length;i++){addStyle(styles[i].text)}var scripts=tale.lookup("tags","script");for(var i=0;i<scripts.length;i++){try{eval(scripts[i].text)}catch(e){alert("There is a technical problem with this story ("+scripts[i].title+": "+e.message+"). You may be able to continue reading, but all parts of the story may not work properly.")}}state=new History();state.init()}Interface={init:function(){main();$("snapback").onclick=Interface.showSnapback;$("restart").onclick=Interface.restart;$("share").onclick=Interface.showShare},restart:function(){if(confirm("Are you sure you want to restart this story?")){state.restart()}},showShare:function(B){Interface.hideAllMenus();Interface.showMenu(B,$("shareMenu"))},showSnapback:function(B){Interface.hideAllMenus();Interface.buildSnapback();Interface.showMenu(B,$("snapbackMenu"))},buildSnapback:function(){var E=false;removeChildren($("snapbackMenu"));for(var D=state.history.length-1;D>=0;D--){if(state.history[D].passage&&state.history[D].passage.tags.indexOf("bookmark")!=-1){var F=document.createElement("div");F.hash=state.history[D].hash;F.onclick=function(){window.location.hash=this.hash};F.innerHTML=state.history[D].passage.excerpt();$("snapbackMenu").appendChild(F);E=true}}if(!E){var F=document.createElement("div");F.innerHTML="<i>No passages available</i>";$("snapbackMenu").appendChild(F)}},hideAllMenus:function(){$("shareMenu").style.display="none";$("snapbackMenu").style.display="none"},showMenu:function(F,D){if(!F){F=window.event}var E={x:0,y:0};if(F.pageX||F.pageY){E.x=F.pageX;E.y=F.pageY}else{if(F.clientX||F.clientY){E.x=F.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;E.y=F.clientY+document.body.scrollTop+document.documentElement.scrollTop}}D.style.top=E.y+"px";D.style.left=E.x+"px";D.style.display="block";document.onclick=Interface.hideAllMenus;F.cancelBubble=true;if(F.stopPropagation){F.stopPropagation()}}};window.onload=Interface.init;version.extensions.backMacro={major:1,minor:0,revision:0};macros.back={handler:function(F,J,G){var H="";if(G[0]){for(var I=0;I<state.history.length;I++){if(state.history[I].passage.title==G[0]){H=state.history[I].hash;break}}if(H==""){throwError(F,"can't find passage \""+G[0]+'" in history');return }}else{H=state.history[1].hash}el=document.createElement("a");el.className="back";el.href=H;el.innerHTML="<b>&laquo;</b> Back";F.appendChild(el)}};version.extensions.displayMacro={major:1,minor:0,revision:0};macros.display={handler:function(D,F,E){new Wikifier(D,tale.get(E[0]).text)}};version.extensions.actionsMacro={major:1,minor:1,revision:0};macros.actions={clicked:new Object(),handler:function(H,J,I){var K=insertElement(H,"ul");for(var N=0;N<I.length;N++){if(macros.actions.clicked[I[N]]){continue}var L=insertElement(K,"li");var M=Wikifier.createInternalLink(L,I[N]);insertText(M,I[N]);M.onclick=function(){macros.actions.clicked[this.id]=true;state.display(this.id,M)}}}};version.extensions.printMacro={major:1,minor:1,revision:0};macros.print={handler:function(place,macroName,params,parser){try{var output=eval(parser.fullArgs());if(output){new Wikifier(place,output.toString())}}catch(e){throwError(place,"bad expression: "+e.message)}}};version.extensions.setMacro={major:1,minor:1,revision:0};macros.set={handler:function(E,H,G,F){macros.set.run(F.fullArgs())},run:function(expression){try{return eval(Wikifier.parse(expression))}catch(e){throwError(place,"bad expression: "+e.message)}}};version.extensions.ifMacros={major:1,minor:0,revision:0};macros["if"]={handler:function(place,macroName,params,parser){var condition=parser.fullArgs();var srcOffset=parser.source.indexOf(">>",parser.matchStart)+2;var src=parser.source.slice(srcOffset);var endPos=-1;var trueClause="";var falseClause="";for(var i=0,nesting=1,currentClause=true;i<src.length;i++){if(src.substr(i,9)=="<<endif>>"){nesting--;if(nesting==0){endPos=srcOffset+i+9;break}}if((src.substr(i,8)=="<<else>>")&&(nesting==1)){currentClause="false";i+=8}if(src.substr(i,5)=="<<if "){nesting++}if(currentClause==true){trueClause+=src.charAt(i)}else{falseClause+=src.charAt(i)}}try{if(eval(condition)){new Wikifier(place,trueClause.trim())}else{new Wikifier(place,falseClause.trim())}if(endPos!=-1){parser.nextMatch=endPos}else{throwError(place,"can't find matching endif")}}catch(e){throwError(place,"bad condition: "+e.message)}}};macros["else"]=macros.endif={handler:function(){}};version.extensions.rememberMacro={major:1,minor:0,revision:0};macros.remember={handler:function(place,macroName,params,parser){var statement=parser.fullArgs();var expire=new Date();var variable,value;macros.set.run(statement);variable=statement.match(new RegExp(Wikifier.parse("$")+"(\\w+)","i"))[1];value=eval(Wikifier.parse("$"+variable));switch(typeof value){case"string":value='"'+value.replace(/"/g,'\\"')+'"';break;case"number":case"boolean":break;default:throwError(place,"can't remember $"+variable+" ("+(typeof value)+")");return }expire.setYear(expire.getFullYear()+1);document.cookie=macros.remember.prefix+variable+"="+value+"; expires="+expire.toGMTString()},init:function(){if(tale.has("StoryTitle")){macros.remember.prefix=tale.get("StoryTitle").text+"_"}else{macros.remember.prefix="__jonah_"}var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){var bits=cookies[i].split("=");if(bits[0].trim().indexOf(this.prefix)==0){var statement=cookies[i].replace(this.prefix,"$");eval(Wikifier.parse(statement))}}}};version.extensions.SilentlyMacro={major:1,minor:0,revision:0};macros.silently={handler:function(R,T,S,M){var Q=insertElement(null,"div");var O=M.source.indexOf(">>",M.matchStart)+2;var N=M.source.slice(O);var K=-1;var L="";for(var P=0;P<N.length;P++){if(N.substr(P,15)=="<<endsilently>>"){K=O+P+15}else{L+=N.charAt(P)}}if(K!=-1){new Wikifier(Q,L);M.nextMatch=K}else{throwError(R,"can't find matching endsilently")}delete Q}};macros.endsilently={handler:function(){}};function Passage(E,F,D){this.title=E;if(F){this.id=D;this.initialText=this.text=Passage.unescapeLineBreaks(F.firstChild?F.firstChild.nodeValue:"");this.tags=F.getAttribute("tags");if(typeof this.tags=="string"){this.tags=this.tags.readBracketedList()}else{this.tags=[]}}else{this.initialText=this.text="@@This passage does not exist.@@";this.tags=[]}}Passage.prototype.render=function(){var D=insertElement(null,"div","passage"+this.title,"passage");D.style.visibility="hidden";insertElement(D,"div","","header");var C=insertElement(D,"div","","content");new Wikifier(C,this.text);insertElement(D,"div","","footer");return D};Passage.prototype.reset=function(){this.text=this.initialText};Passage.prototype.excerpt=function(){var D=this.text.replace(/<<.*?>>/g,"");D=D.replace(/!.*?\n/g,"");D=D.replace(/[\[\]\/]/g,"");var C=D.match(/(.*?\s.*?\s.*?\s.*?\s.*?\s.*?\s.*?)\s/);return C[1]+"..."};Passage.unescapeLineBreaks=function(B){if(B&&B!=""){return B.replace(/\\n/mg,"\n").replace(/\\/mg,"\\").replace(/\r/mg,"")}else{return""}};function Tale(){this.passages={};if(document.normalize){document.normalize()}var D=$("storeArea").childNodes;for(var F=0;F<D.length;F++){var E=D[F];if(E.getAttribute&&(tiddlerTitle=E.getAttribute("tiddler"))){this.passages[tiddlerTitle]=new Passage(tiddlerTitle,E,F)}}this.title="Sugarcane";if(this.passages.StoryTitle){this.title=this.passages.StoryTitle.text}}Tale.prototype.has=function(B){if(typeof B=="string"){return(this.passages[B]!=null)}else{for(i in this.passages){if(this.passages[i].id==B){return true}}return false}};Tale.prototype.get=function(B){if(typeof B=="string"){return this.passages[B]||new Passage(B)}else{for(i in this.passages){if(this.passages[i].id==B){return this.passages[i]}}}};Tale.prototype.lookup=function(J,K,I){var N=[];for(var O in this.passages){var L=this.passages[O];var M=false;for(var P=0;P<L[J].length;P++){if(L[J][P]==K){N.push(L)}}}if(!I){I="title"}N.sort(function(A,B){if(A[I]==B[I]){return(0)}else{return(A[I]<B[I])?-1:+1}});return N};Tale.prototype.reset=function(){for(i in this.passages){this.passages[i].reset()}};function Wikifier(C,D){this.source=D;this.output=C;this.nextMatch=0;this.assembleFormatterMatches(Wikifier.formatters);this.subWikify(this.output)}Wikifier.prototype.assembleFormatterMatches=function(D){this.formatters=[];var F=[];for(var E=0;E<D.length;E++){F.push("("+D[E].match+")");this.formatters.push(D[E])}this.formatterRegExp=new RegExp(F.join("|"),"mg")};Wikifier.prototype.subWikify=function(O,P){var I=this.output;this.output=O;var L=P?new RegExp("("+P+")","mg"):null;do{this.formatterRegExp.lastIndex=this.nextMatch;if(L){L.lastIndex=this.nextMatch}var K=this.formatterRegExp.exec(this.source);var M=L?L.exec(this.source):null;if(M&&(!K||M.index<=K.index)){if(M.index>this.nextMatch){this.outputText(this.output,this.nextMatch,M.index)}this.matchStart=M.index;this.matchLength=M[1].length;this.matchText=M[1];this.nextMatch=M.index+M[1].length;this.output=I;return }else{if(K){if(K.index>this.nextMatch){this.outputText(this.output,this.nextMatch,K.index)}this.matchStart=K.index;this.matchLength=K[0].length;this.matchText=K[0];this.nextMatch=this.formatterRegExp.lastIndex;var J=-1;for(var N=1;N<K.length;N++){if(K[N]){matchingFormatter=N-1}}if(matchingFormatter!=-1){this.formatters[matchingFormatter].handler(this)}}}}while(M||K);if(this.nextMatch<this.source.length){this.outputText(this.output,this.nextMatch,this.source.length);this.nextMatch=this.source.length}this.output=I};Wikifier.prototype.outputText=function(D,E,F){insertText(D,this.source.substring(E,F))};Wikifier.prototype.fullArgs=function(){var D=this.source.indexOf(" ",this.matchStart);var C=this.source.indexOf(">>",this.matchStart);return Wikifier.parse(this.source.slice(D,C))};Wikifier.parse=function(D){var C=D.replace(/\$/g,"state.history[0].variables.");C=C.replace(/\beq\b/gi," == ");C=C.replace(/\bneq\b/gi," != ");C=C.replace(/\bgt\b/gi," > ");C=C.replace(/\beq\b/gi," == ");C=C.replace(/\bneq\b/gi," != ");C=C.replace(/\bgt\b/gi," > ");C=C.replace(/\bgte\b/gi," >= ");C=C.replace(/\blt\b/gi," < ");C=C.replace(/\blte\b/gi," <= ");C=C.replace(/\band\b/gi," && ");C=C.replace(/\bor\b/gi," || ");C=C.replace(/\bnot\b/gi," ! ");return C};Wikifier.formatHelpers={charFormatHelper:function(C){var D=insertElement(C.output,this.element);C.subWikify(D,this.terminator)},inlineCssHelper:function(Q){var O=[];var M="(?:("+Wikifier.textPrimitives.anyLetter+"+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:("+Wikifier.textPrimitives.anyLetter+"+):([^;\\|\\n]+);)";var L=new RegExp(M,"mg");var K=false;do{L.lastIndex=Q.nextMatch;var J=L.exec(Q.source);var R=J&&J.index==Q.nextMatch;if(R){var N,P;K=true;if(J[1]){N=J[1].unDash();P=J[2]}else{N=J[3].unDash();P=J[4]}switch(N){case"bgcolor":N="backgroundColor";break}O.push({style:N,value:P});Q.nextMatch=J.index+J[0].length}}while(R);return O},monospacedByLineHelper:function(F){var J=new RegExp(this.lookahead,"mg");J.lastIndex=F.matchStart;var I=J.exec(F.source);if(I&&I.index==F.matchStart){var G=I[1];if(navigator.userAgent.indexOf("msie")!=-1&&navigator.userAgent.indexOf("opera")==-1){G=G.replace(/\n/g,"\r")}var H=insertElement(F.output,"pre",null,null,G);F.nextMatch=I.index+I[0].length}}};Wikifier.formatters=[{name:"table",match:"^\\|(?:[^\\n]*)\\|(?:[fhc]?)$",lookahead:"^\\|([^\\n]*)\\|([fhc]?)$",rowTerminator:"\\|(?:[fhc]?)$\\n?",cellPattern:"(?:\\|([^\\n\\|]*)\\|)|(\\|[fhc]?$\\n?)",cellTerminator:"(?:\\x20*)\\|",rowTypes:{c:"caption",h:"thead","":"tbody",f:"tfoot"},handler:function(S){var Q=insertElement(S.output,"table");S.nextMatch=S.matchStart;var M=new RegExp(this.lookahead,"mg");var L=null,O;var P,V;var R=[];var T=0;do{M.lastIndex=S.nextMatch;var U=M.exec(S.source);var N=U&&U.index==S.nextMatch;if(N){O=U[2];if(O!=L){P=insertElement(Q,this.rowTypes[O])}L=O;if(L=="c"){if(T==0){P.setAttribute("align","top")}else{P.setAttribute("align","bottom")}S.nextMatch=S.nextMatch+1;S.subWikify(P,this.rowTerminator)}else{V=insertElement(P,"tr");this.rowHandler(S,V,R)}T++}}while(N)},rowHandler:function(X,N,T){var Q=0;var V=1;var O=new RegExp(this.cellPattern,"mg");do{O.lastIndex=X.nextMatch;var Z=O.exec(X.source);matched=Z&&Z.index==X.nextMatch;if(matched){if(Z[1]=="~"){var U=T[Q];if(U){U.rowCount++;U.element.setAttribute("rowSpan",U.rowCount);U.element.setAttribute("rowspan",U.rowCount);U.element.valign="center"}X.nextMatch=Z.index+Z[0].length-1}else{if(Z[1]==">"){V++;X.nextMatch=Z.index+Z[0].length-1}else{if(Z[2]){X.nextMatch=Z.index+Z[0].length;break}else{var P=false,Y=false;X.nextMatch++;var R=Wikifier.formatHelpers.inlineCssHelper(X);while(X.source.substr(X.nextMatch,1)==" "){P=true;X.nextMatch++}var W;if(X.source.substr(X.nextMatch,1)=="!"){W=insertElement(N,"th");X.nextMatch++}else{W=insertElement(N,"td")}T[Q]={rowCount:1,element:W};lastColCount=1;lastColElement=W;if(V>1){W.setAttribute("colSpan",V);W.setAttribute("colspan",V);V=1}for(var S=0;S<R.length;S++){W.style[R[S].style]=R[S].value}X.subWikify(W,this.cellTerminator);if(X.matchText.substr(X.matchText.length-2,1)==" "){Y=true}if(P&&Y){W.align="center"}else{if(P){W.align="right"}else{if(Y){W.align="left"}}}X.nextMatch=X.nextMatch-1}}}Q++}}while(matched)}},{name:"rule",match:"^----$\\n?",handler:function(B){insertElement(B.output,"hr")}},{name:"emdash",match:"--",handler:function(C){var D=insertElement(C.output,"span");D.innerHTML="&mdash;"}},{name:"heading",match:"^!{1,5}",terminator:"\\n",handler:function(C){var D=insertElement(C.output,"h"+C.matchLength);C.subWikify(D,this.terminator)}},{name:"monospacedByLine",match:"^\\{\\{\\{\\n",lookahead:"^\\{\\{\\{\\n((?:^[^\\n]*\\n)+?)(^\\}\\}\\}$\\n?)",handler:Wikifier.formatHelpers.monospacedByLineHelper},{name:"monospacedByLineForPlugin",match:"^//\\{\\{\\{\\n",lookahead:"^//\\{\\{\\{\\n\\n*((?:^[^\\n]*\\n)+?)(\\n*^//\\}\\}\\}$\\n?)",handler:Wikifier.formatHelpers.monospacedByLineHelper},{name:"wikifyCommentForPlugin",match:"^/\\*\\*\\*\\n",terminator:"^\\*\\*\\*/\\n",handler:function(B){B.subWikify(B.output,this.terminator)}},{name:"quoteByBlock",match:"^<<<\\n",terminator:"^<<<\\n",handler:function(C){var D=insertElement(C.output,"blockquote");C.subWikify(D,this.terminator)}},{name:"quoteByLine",match:"^>+",terminator:"\\n",element:"blockquote",handler:function(O){var M=new RegExp(this.match,"mg");var N=[O.output];var J=0;var P=O.matchLength;var K;do{if(P>J){for(K=J;K<P;K++){N.push(insertElement(N[N.length-1],this.element))}}else{if(P<J){for(K=J;K>P;K--){N.pop()}}}J=P;O.subWikify(N[N.length-1],this.terminator);insertElement(N[N.length-1],"br");M.lastIndex=O.nextMatch;var L=M.exec(O.source);var I=L&&L.index==O.nextMatch;if(I){P=L[0].length;O.nextMatch+=L[0].length}}while(I)}},{name:"list",match:"^(?:(?:\\*+)|(?:#+))",lookahead:"^(?:(\\*+)|(#+))",terminator:"\\n",outerElement:"ul",itemElement:"li",handler:function(R){var N=new RegExp(this.lookahead,"mg");R.nextMatch=R.matchStart;var V=[R.output];var Q=null,M;var T=0,L;var P;do{N.lastIndex=R.nextMatch;var U=N.exec(R.source);var O=U&&U.index==R.nextMatch;if(O){if(U[1]){M="ul"}if(U[2]){M="ol"}L=U[0].length;R.nextMatch+=U[0].length;if(L>T){for(P=T;P<L;P++){V.push(insertElement(V[V.length-1],M))}}else{if(L<T){for(P=T;P>L;P--){V.pop()}}else{if(L==T&&M!=Q){V.pop();V.push(insertElement(V[V.length-1],M))}}}T=L;Q=M;var S=insertElement(V[V.length-1],"li");R.subWikify(S,this.terminator)}}while(O)}},{name:"prettyLink",match:"\\[\\[",lookahead:"\\[\\[([^\\|\\]]*?)(?:(\\]\\])|(\\|(.*?)\\]\\]))",terminator:"\\|",handler:function(F){var J=new RegExp(this.lookahead,"mg");J.lastIndex=F.matchStart;var I=J.exec(F.source);if(I&&I.index==F.matchStart&&I[2]){var H=Wikifier.createInternalLink(F.output,I[1]);F.outputText(H,F.nextMatch,F.nextMatch+I[1].length);F.nextMatch+=I[1].length+2}else{if(I&&I.index==F.matchStart&&I[3]){var G;if(tale.has(I[4])){G=Wikifier.createInternalLink(F.output,I[4])}else{G=Wikifier.createExternalLink(F.output,I[4])}F.outputText(G,F.nextMatch,F.nextMatch+I[1].length);F.nextMatch=I.index+I[0].length}}}},{name:"urlLink",match:"(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)",handler:function(C){var D=Wikifier.createExternalLink(C.output,C.matchText);C.outputText(D,C.matchStart,C.nextMatch)}},{name:"image",match:"\\[(?:[<]{0,1})(?:[>]{0,1})[Ii][Mm][Gg]\\[",lookahead:"\\[([<]{0,1})([>]{0,1})[Ii][Mm][Gg]\\[(?:([^\\|\\]]+)\\|)?([^\\[\\]\\|]+)\\](?:\\[([^\\]]*)\\]?)?(\\])",handler:function(F){var I=new RegExp(this.lookahead,"mg");I.lastIndex=F.matchStart;var H=I.exec(F.source);if(H&&H.index==F.matchStart){var G=F.output;if(H[5]){if(tale.has(H[5])){G=Wikifier.createInternalLink(F.output,H[5])}else{G=Wikifier.createExternalLink(F.output,H[5])}}var J=insertElement(G,"img");if(H[1]){J.align="left"}else{if(H[2]){J.align="right"}}if(H[3]){J.title=H[3]}J.src=H[4];F.nextMatch=H.index+H[0].length}}},{name:"macro",match:"<<",lookahead:"<<([^>\\s]+)(?:\\s*)([^>]*)>>",handler:function(G){var L=new RegExp(this.lookahead,"mg");L.lastIndex=G.matchStart;var K=L.exec(G.source);if(K&&K.index==G.matchStart&&K[1]){var H=K[2].readMacroParams();G.nextMatch=K.index+K[0].length;try{var J=macros[K[1]];if(J&&J.handler){J.handler(G.output,K[1],H,G)}else{insertElement(G.output,"span",null,"marked","macro not found: "+K[1])}}catch(I){throwError(G.output,"Error executing macro "+K[1]+": "+I.toString())}}}},{name:"html",match:"<[Hh][Tt][Mm][Ll]>",lookahead:"<[Hh][Tt][Mm][Ll]>((?:.|\\n)*?)</[Hh][Tt][Mm][Ll]>",handler:function(E){var H=new RegExp(this.lookahead,"mg");H.lastIndex=E.matchStart;var G=H.exec(E.source);if(G&&G.index==E.matchStart){var F=insertElement(E.output,"span");F.innerHTML=G[1];E.nextMatch=G.index+G[0].length}}},{name:"commentByBlock",match:"/%",lookahead:"/%((?:.|\\n)*?)%/",handler:function(D){var F=new RegExp(this.lookahead,"mg");F.lastIndex=D.matchStart;var E=F.exec(D.source);if(E&&E.index==D.matchStart){D.nextMatch=E.index+E[0].length}}},{name:"boldByChar",match:"''",terminator:"''",element:"strong",handler:Wikifier.formatHelpers.charFormatHelper},{name:"strikeByChar",match:"==",terminator:"==",element:"strike",handler:Wikifier.formatHelpers.charFormatHelper},{name:"underlineByChar",match:"__",terminator:"__",element:"u",handler:Wikifier.formatHelpers.charFormatHelper},{name:"italicByChar",match:"//",terminator:"//",element:"em",handler:Wikifier.formatHelpers.charFormatHelper},{name:"subscriptByChar",match:"~~",terminator:"~~",element:"sub",handler:Wikifier.formatHelpers.charFormatHelper},{name:"superscriptByChar",match:"\\^\\^",terminator:"\\^\\^",element:"sup",handler:Wikifier.formatHelpers.charFormatHelper},{name:"monospacedByChar",match:"\\{\\{\\{",lookahead:"\\{\\{\\{((?:.|\\n)*?)\\}\\}\\}",handler:function(E){var H=new RegExp(this.lookahead,"mg");H.lastIndex=E.matchStart;var G=H.exec(E.source);if(G&&G.index==E.matchStart){var F=insertElement(E.output,"code",null,null,G[1]);E.nextMatch=G.index+G[0].length}}},{name:"styleByChar",match:"@@",terminator:"@@",lookahead:"(?:([^\\(@]+)\\(([^\\)]+)(?:\\):))|(?:([^:@]+):([^;]+);)",handler:function(E){var F=insertElement(E.output,"span",null,null,null);var G=Wikifier.formatHelpers.inlineCssHelper(E);if(G.length==0){F.className="marked"}else{for(var H=0;H<G.length;H++){F.style[G[H].style]=G[H].value}}E.subWikify(F,this.terminator)}},{name:"lineBreak",match:"\\n",handler:function(B){insertElement(B.output,"br")}}];Wikifier.textPrimitives={anyDigit:"[0-9]",anyNumberChar:"[0-9\\.E]",urlPattern:"(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)"};Wikifier.createInternalLink=function(D,E){var F=insertElement(D,"a",E);F.href="javascript:void(0)";if(tale.has(E)){F.className="internalLink"}else{F.className="brokenLink"}F.onclick=function(){state.display(E,F)};if(D){D.appendChild(F)}return F};Wikifier.createExternalLink=function(D,F){var E=insertElement(D,"a");E.href=F;E.className="externalLink";E.target="_blank";if(D){D.appendChild(E)}return E};if(!((new RegExp("[\u0150\u0170]","g")).test("\u0150"))){Wikifier.textPrimitives.upperLetter="[A-Z\u00c0-\u00de]";Wikifier.textPrimitives.lowerLetter="[a-z\u00df-\u00ff_0-9\\-]";Wikifier.textPrimitives.anyLetter="[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-]"}else{Wikifier.textPrimitives.upperLetter="[A-Z\u00c0-\u00de\u0150\u0170]";Wikifier.textPrimitives.lowerLetter="[a-z\u00df-\u00ff_0-9\\-\u0151\u0171]";Wikifier.textPrimitives.anyLetter="[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-\u0150\u0170\u0151\u0171]"}function $(A){if(typeof A=="string"){return document.getElementById(A)}else{return A}}function clone(A){var B={};for(property in A){B[property]=A[property]}return B}function insertElement(A,D,F,C,E){var B=document.createElement(D);if(F){B.id=F}if(C){B.className=C}if(E){insertText(B,E)}if(A){A.appendChild(B)}return B}function insertText(A,B){return A.appendChild(document.createTextNode(B))}function removeChildren(A){while(A.hasChildNodes()){A.removeChild(A.firstChild)}}function setPageElement(C,B,A){if(place=$(C)){removeChildren(place);if(tale.has(B)){new Wikifier(place,tale.get(B).text)}else{new Wikifier(place,A)}}}function addStyle(B){if(document.createStyleSheet){document.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd","&nbsp;<style>"+B+"</style>")}else{var A=document.createElement("style");A.type="text/css";A.appendChild(document.createTextNode(B));document.getElementsByTagName("head")[0].appendChild(A)}}function throwError(A,B){new Wikifier(A,"'' @@ "+B+" @@ ''")}Math.easeInOut=function(A){return(1-((Math.cos(A*Math.PI)+1)/2))};String.prototype.readMacroParams=function(){var C=new RegExp("(?:\\s*)(?:(?:\"([^\"]*)\")|(?:'([^']*)')|(?:\\[\\[([^\\]]*)\\]\\])|([^\"'\\s]\\S*))","mg");var B=[];do{var A=C.exec(this);if(A){if(A[1]){B.push(A[1])}else{if(A[2]){B.push(A[2])}else{if(A[3]){B.push(A[3])}else{if(A[4]){B.push(A[4])}}}}}}while(A);return B};String.prototype.readBracketedList=function(){var B="\\[\\[([^\\]]+)\\]\\]";var A="[^\\s$]+";var E="(?:"+B+")|("+A+")";var D=new RegExp(E,"mg");var F=[];do{var C=D.exec(this);if(C){if(C[1]){F.push(C[1])}else{if(C[2]){F.push(C[2])}}}}while(C);return(F)};String.prototype.trim=function(){var A=new RegExp("^\\s*(.*?)\\s*$","mg");return(this.replace(A,"$1"))};Array.prototype.indexOf||(Array.prototype.indexOf=function(B,D){D=(D==null)?0:D;var A=this.length;for(var C=D;C<A;C++){if(this[C]==B){return C}}return -1});function fade(F,C){var H;var E=F.cloneNode(true);var G=(C.fade=="in")?1:-1;F.parentNode.replaceChild(E,F);if(C.fade=="in"){H=0;E.style.visibility="visible"}else{H=1}B(E,H);var A=window.setInterval(D,25);function D(){H+=0.05*G;B(E,Math.easeInOut(H));if(((G==1)&&(H>=1))||((G==-1)&&(H<=0))){F.style.visibility=(C.fade=="in")?"visible":"hidden";E.parentNode.replaceChild(F,E);delete E;window.clearInterval(A);if(C.onComplete){C.onComplete()}}}function B(J,I){var K=Math.floor(I*100);J.style.zoom=1;J.style.filter="alpha(opacity="+K+")";J.style.opacity=I}}function scrollWindowTo(E){var D=window.scrollY?window.scrollY:document.body.scrollTop;var G=J(E);var C=Math.abs(D-G);var B=0;var I=(D>G)?-1:1;var F=window.setInterval(H,25);function H(){B+=0.1;window.scrollTo(0,D+I*(C*Math.easeInOut(B)));if(B>=1){window.clearInterval(F)}}function J(N){var O=A(N);var P=O+N.offsetHeight;var K=window.scrollY?window.scrollY:document.body.scrollTop;var L=window.innerHeight?window.innerHeight:document.body.clientHeight;var M=K+L;if(O<K){return O}else{if(P>M){if(N.offsetHeight<L){return(O-(L-N.offsetHeight)+20)}else{return O}}else{return O}}}function A(K){var L=0;while(K.offsetParent){L+=K.offsetTop;K=K.offsetParent}return L}}function History(){this.history=[{passage:null,variables:{},hash:null}]}History.prototype.init=function(){var A=this;if(!this.restore()){this.display("Start",null)}this.hash=window.location.hash;this.interval=window.setInterval(function(){A.watchHash.apply(A)},250)};History.prototype.display=function(D,B,A){var C=tale.get(D);this.history.unshift({passage:C,variables:clone(this.history[0].variables)});this.history[0].hash=this.save();var E=C.render();if(A!="offscreen"){removeChildren($("passages"));$("passages").appendChild(E);if(A!="quietly"){fade(E,{fade:"in"})}}if((A=="quietly")||(A=="offscreen")){E.style.visibility="visible"}if(A!="offscreen"){document.title=tale.title;this.hash=this.save();if(C.title!="Start"){document.title+=": "+C.title;window.location.hash=this.hash}window.scroll(0,0)}return E};History.prototype.restart=function(){window.location.hash=""};History.prototype.save=function(C){var A="";for(var B=this.history.length-1;B>=0;B--){if((this.history[B].passage)&&(this.history[B].passage.id)){A+=this.history[B].passage.id.toString(36)+"."}}return"#"+A.substr(0,A.length-1)};History.prototype.restore=function(){try{if((window.location.hash=="")||(window.location.hash=="#")){return false}var A=window.location.hash.replace("#","").split(".");var C=[];for(var B=0;B<A.length;B++){var F=parseInt(A[B],36);if(!tale.has(F)){return false}var E=(B==A.length-1)?"":"offscreen";C.unshift(this.display(F,null,E))}return true}catch(D){return false}};History.prototype.watchHash=function(){if(window.location.hash!=this.hash){if((window.location.hash!="")&&(window.location.hash!="#")){this.history=[{passage:null,variables:{}}];removeChildren($("passages"));$("passages").style.visibility="hidden";if(!this.restore()){alert("The passage you had previously visited could not be found.")}$("passages").style.visibility="visible"}else{window.location.reload()}this.hash=window.location.hash}};var version={major:2,minor:0,revision:0,date:new Date("July 30, 2007"),extensions:{}};var tale,state;var macros={};function main(){tale=new Tale();document.title=tale.title;setPageElement("storyTitle","StoryTitle","Untitled Story");if(tale.has("StoryAuthor")){$("titleSeparator").innerHTML="<br />";setPageElement("storyAuthor","StoryAuthor","")}if(tale.has("StoryMenu")){$("storyMenu").style.display="block";setPageElement("storyMenu","StoryMenu","")}for(macro in macros){if(typeof macro.init=="function"){macro.init()}}var styles=tale.lookup("tags","stylesheet");for(var i=0;i<styles.length;i++){addStyle(styles[i].text)}var scripts=tale.lookup("tags","script");for(var i=0;i<scripts.length;i++){try{eval(scripts[i].text)}catch(e){alert("There is a technical problem with this story ("+scripts[i].title+": "+e.message+"). You may be able to continue reading, but all parts of the story may not work properly.")}}state=new History();state.init()}Interface={init:function(){main();$("snapback").onclick=Interface.showSnapback;$("restart").onclick=Interface.restart;$("share").onclick=Interface.showShare},restart:function(){if(confirm("Are you sure you want to restart this story?")){state.restart()}},showShare:function(A){Interface.hideAllMenus();Interface.showMenu(A,$("shareMenu"))},showSnapback:function(A){Interface.hideAllMenus();Interface.buildSnapback();Interface.showMenu(A,$("snapbackMenu"))},buildSnapback:function(){var C=false;removeChildren($("snapbackMenu"));for(var A=state.history.length-1;A>=0;A--){if(state.history[A].passage&&state.history[A].passage.tags.indexOf("bookmark")!=-1){var B=document.createElement("div");B.hash=state.history[A].hash;B.onclick=function(){window.location.hash=this.hash};B.innerHTML=state.history[A].passage.excerpt();$("snapbackMenu").appendChild(B);C=true}}if(!C){var B=document.createElement("div");B.innerHTML="<i>No passages available</i>";$("snapbackMenu").appendChild(B)}},hideAllMenus:function(){$("shareMenu").style.display="none";$("snapbackMenu").style.display="none"},showMenu:function(B,A){if(!B){B=window.event}var C={x:0,y:0};if(B.pageX||B.pageY){C.x=B.pageX;C.y=B.pageY}else{if(B.clientX||B.clientY){C.x=B.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;C.y=B.clientY+document.body.scrollTop+document.documentElement.scrollTop}}A.style.top=C.y+"px";A.style.left=C.x+"px";A.style.display="block";document.onclick=Interface.hideAllMenus;B.cancelBubble=true;if(B.stopPropagation){B.stopPropagation()}}};window.onload=Interface.init;version.extensions.backMacro={major:1,minor:0,revision:0};macros.back={handler:function(A,B,E){var D="";if(E[0]){for(var C=0;C<state.history.length;C++){if(state.history[C].passage.title==E[0]){D=state.history[C].hash;break}}if(D==""){throwError(A,"can't find passage \""+E[0]+'" in history');return }}else{D=state.history[1].hash}el=document.createElement("a");el.className="back";el.href=D;el.innerHTML="<b>&laquo;</b> Back";A.appendChild(el)}};version.extensions.displayMacro={major:1,minor:0,revision:0};macros.display={handler:function(A,B,C){new Wikifier(A,tale.get(C[0]).text)}};version.extensions.actionsMacro={major:1,minor:1,revision:0};macros.actions={clicked:new Object(),handler:function(A,F,G){var E=insertElement(A,"ul");for(var B=0;B<G.length;B++){if(macros.actions.clicked[G[B]]){continue}var D=insertElement(E,"li");var C=Wikifier.createInternalLink(D,G[B]);insertText(C,G[B]);C.onclick=function(){macros.actions.clicked[this.id]=true;state.display(this.id,C)}}}};version.extensions.printMacro={major:1,minor:1,revision:0};macros.print={handler:function(place,macroName,params,parser){try{var output=eval(parser.fullArgs());if(output){new Wikifier(place,output.toString())}}catch(e){throwError(place,"bad expression: "+e.message)}}};version.extensions.setMacro={major:1,minor:1,revision:0};macros.set={handler:function(A,B,C,D){macros.set.run(D.fullArgs())},run:function(expression){try{return eval(Wikifier.parse(expression))}catch(e){throwError(place,"bad expression: "+e.message)}}};version.extensions.ifMacros={major:1,minor:0,revision:0};macros["if"]={handler:function(place,macroName,params,parser){var condition=parser.fullArgs();var srcOffset=parser.source.indexOf(">>",parser.matchStart)+2;var src=parser.source.slice(srcOffset);var endPos=-1;var trueClause="";var falseClause="";for(var i=0,nesting=1,currentClause=true;i<src.length;i++){if(src.substr(i,9)=="<<endif>>"){nesting--;if(nesting==0){endPos=srcOffset+i+9;break}}if((src.substr(i,8)=="<<else>>")&&(nesting==1)){currentClause="false";i+=8}if(src.substr(i,5)=="<<if "){nesting++}if(currentClause==true){trueClause+=src.charAt(i)}else{falseClause+=src.charAt(i)}}try{if(eval(condition)){new Wikifier(place,trueClause.trim())}else{new Wikifier(place,falseClause.trim())}if(endPos!=-1){parser.nextMatch=endPos}else{throwError(place,"can't find matching endif")}}catch(e){throwError(place,"bad condition: "+e.message)}}};macros["else"]=macros.endif={handler:function(){}};version.extensions.rememberMacro={major:1,minor:0,revision:0};macros.remember={handler:function(place,macroName,params,parser){var statement=parser.fullArgs();var expire=new Date();var variable,value;macros.set.run(statement);variable=statement.match(new RegExp(Wikifier.parse("$")+"(\\w+)","i"))[1];value=eval(Wikifier.parse("$"+variable));switch(typeof value){case"string":value='"'+value.replace(/"/g,'\\"')+'"';break;case"number":case"boolean":break;default:throwError(place,"can't remember $"+variable+" ("+(typeof value)+")");return }expire.setYear(expire.getFullYear()+1);document.cookie=macros.remember.prefix+variable+"="+value+"; expires="+expire.toGMTString()},init:function(){if(tale.has("StoryTitle")){macros.remember.prefix=tale.get("StoryTitle").text+"_"}else{macros.remember.prefix="__jonah_"}var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){var bits=cookies[i].split("=");if(bits[0].trim().indexOf(this.prefix)==0){var statement=cookies[i].replace(this.prefix,"$");eval(Wikifier.parse(statement))}}}};version.extensions.SilentlyMacro={major:1,minor:0,revision:0};macros.silently={handler:function(G,E,F,B){var H=insertElement(null,"div");var J=B.source.indexOf(">>",B.matchStart)+2;var A=B.source.slice(J);var D=-1;var C="";for(var I=0;I<A.length;I++){if(A.substr(I,15)=="<<endsilently>>"){D=J+I+15}else{C+=A.charAt(I)}}if(D!=-1){new Wikifier(H,C);B.nextMatch=D}else{throwError(G,"can't find matching endsilently")}delete H}};macros.endsilently={handler:function(){}};function Passage(C,B,A){this.title=C;if(B){this.id=A;this.initialText=this.text=Passage.unescapeLineBreaks(B.firstChild?B.firstChild.nodeValue:"");this.tags=B.getAttribute("tags");if(typeof this.tags=="string"){this.tags=this.tags.readBracketedList()}else{this.tags=[]}}else{this.initialText=this.text="@@This passage does not exist.@@";this.tags=[]}}Passage.prototype.render=function(){var B=insertElement(null,"div","passage"+this.title,"passage");B.style.visibility="hidden";insertElement(B,"div","","header");var A=insertElement(B,"div","","content");new Wikifier(A,this.text);insertElement(B,"div","","footer");return B};Passage.prototype.reset=function(){this.text=this.initialText};Passage.prototype.excerpt=function(){var B=this.text.replace(/<<.*?>>/g,"");B=B.replace(/!.*?\n/g,"");B=B.replace(/[\[\]\/]/g,"");var A=B.match(/(.*?\s.*?\s.*?\s.*?\s.*?\s.*?\s.*?)\s/);return A[1]+"..."};Passage.unescapeLineBreaks=function(A){if(A&&A!=""){return A.replace(/\\n/mg,"\n").replace(/\\/mg,"\\").replace(/\r/mg,"")}else{return""}};function Tale(){this.passages={};if(document.normalize){document.normalize()}var A=$("storeArea").childNodes;for(var B=0;B<A.length;B++){var C=A[B];if(C.getAttribute&&(tiddlerTitle=C.getAttribute("tiddler"))){this.passages[tiddlerTitle]=new Passage(tiddlerTitle,C,B)}}this.title="Sugarcane";if(this.passages.StoryTitle){this.title=this.passages.StoryTitle.text}}Tale.prototype.has=function(A){if(typeof A=="string"){return(this.passages[A]!=null)}else{for(i in this.passages){if(this.passages[i].id==A){return true}}return false}};Tale.prototype.get=function(A){if(typeof A=="string"){return this.passages[A]||new Passage(A)}else{for(i in this.passages){if(this.passages[i].id==A){return this.passages[i]}}}};Tale.prototype.lookup=function(H,G,A){var D=[];for(var C in this.passages){var F=this.passages[C];var E=false;for(var B=0;B<F[H].length;B++){if(F[H][B]==G){D.push(F)}}}if(!A){A="title"}D.sort(function(J,I){if(J[A]==I[A]){return(0)}else{return(J[A]<I[A])?-1:+1}});return D};Tale.prototype.reset=function(){for(i in this.passages){this.passages[i].reset()}};function $(A){if(typeof A=="string"){return document.getElementById(A)}else{return A}}function clone(A){var B={};for(property in A){B[property]=A[property]}return B}function insertElement(A,D,F,C,E){var B=document.createElement(D);if(F){B.id=F}if(C){B.className=C}if(E){insertText(B,E)}if(A){A.appendChild(B)}return B}function insertText(A,B){return A.appendChild(document.createTextNode(B))}function removeChildren(A){while(A.hasChildNodes()){A.removeChild(A.firstChild)}}function setPageElement(C,B,A){if(place=$(C)){removeChildren(place);if(tale.has(B)){new Wikifier(place,tale.get(B).text)}else{new Wikifier(place,A)}}}function addStyle(B){if(document.createStyleSheet){document.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd","&nbsp;<style>"+B+"</style>")}else{var A=document.createElement("style");A.type="text/css";A.appendChild(document.createTextNode(B));document.getElementsByTagName("head")[0].appendChild(A)}}function throwError(A,B){new Wikifier(A,"'' @@ "+B+" @@ ''")}Math.easeInOut=function(A){return(1-((Math.cos(A*Math.PI)+1)/2))};String.prototype.readMacroParams=function(){var C=new RegExp("(?:\\s*)(?:(?:\"([^\"]*)\")|(?:'([^']*)')|(?:\\[\\[([^\\]]*)\\]\\])|([^\"'\\s]\\S*))","mg");var B=[];do{var A=C.exec(this);if(A){if(A[1]){B.push(A[1])}else{if(A[2]){B.push(A[2])}else{if(A[3]){B.push(A[3])}else{if(A[4]){B.push(A[4])}}}}}}while(A);return B};String.prototype.readBracketedList=function(){var B="\\[\\[([^\\]]+)\\]\\]";var A="[^\\s$]+";var E="(?:"+B+")|("+A+")";var D=new RegExp(E,"mg");var F=[];do{var C=D.exec(this);if(C){if(C[1]){F.push(C[1])}else{if(C[2]){F.push(C[2])}}}}while(C);return(F)};String.prototype.trim=function(){var A=new RegExp("^\\s*(.*?)\\s*$","mg");return(this.replace(A,"$1"))};Array.prototype.indexOf||(Array.prototype.indexOf=function(B,D){D=(D==null)?0:D;var A=this.length;for(var C=D;C<A;C++){if(this[C]==B){return C}}return -1});function fade(F,C){var H;var E=F.cloneNode(true);var G=(C.fade=="in")?1:-1;F.parentNode.replaceChild(E,F);if(C.fade=="in"){H=0;E.style.visibility="visible"}else{H=1}B(E,H);var A=window.setInterval(D,25);function D(){H+=0.05*G;B(E,Math.easeInOut(H));if(((G==1)&&(H>=1))||((G==-1)&&(H<=0))){F.style.visibility=(C.fade=="in")?"visible":"hidden";E.parentNode.replaceChild(F,E);delete E;window.clearInterval(A);if(C.onComplete){C.onComplete()}}}function B(J,I){var K=Math.floor(I*100);J.style.zoom=1;J.style.filter="alpha(opacity="+K+")";J.style.opacity=I}}function scrollWindowTo(E){var D=window.scrollY?window.scrollY:document.body.scrollTop;var G=J(E);var C=Math.abs(D-G);var B=0;var I=(D>G)?-1:1;var F=window.setInterval(H,25);function H(){B+=0.1;window.scrollTo(0,D+I*(C*Math.easeInOut(B)));if(B>=1){window.clearInterval(F)}}function J(N){var O=A(N);var P=O+N.offsetHeight;var K=window.scrollY?window.scrollY:document.body.scrollTop;var L=window.innerHeight?window.innerHeight:document.body.clientHeight;var M=K+L;if(O<K){return O}else{if(P>M){if(N.offsetHeight<L){return(O-(L-N.offsetHeight)+20)}else{return O}}else{return O}}}function A(K){var L=0;while(K.offsetParent){L+=K.offsetTop;K=K.offsetParent}return L}}function History(){this.history=[{passage:null,variables:{},hash:null}]}History.prototype.init=function(){var A=this;if(!this.restore()){this.display("Start",null)}this.hash=window.location.hash;this.interval=window.setInterval(function(){A.watchHash.apply(A)},250)};History.prototype.display=function(D,B,A){var C=tale.get(D);this.history.unshift({passage:C,variables:clone(this.history[0].variables)});this.history[0].hash=this.save();var E=C.render();if(A!="offscreen"){removeChildren($("passages"));$("passages").appendChild(E);if(A!="quietly"){fade(E,{fade:"in"})}}if((A=="quietly")||(A=="offscreen")){E.style.visibility="visible"}if(A!="offscreen"){document.title=tale.title;this.hash=this.save();if(C.title!="Start"){document.title+=": "+C.title;window.location.hash=this.hash}window.scroll(0,0)}return E};History.prototype.restart=function(){window.location.hash=""};History.prototype.save=function(C){var A="";for(var B=this.history.length-1;B>=0;B--){if((this.history[B].passage)&&(this.history[B].passage.id)){A+=this.history[B].passage.id.toString(36)+"."}}return"#"+A.substr(0,A.length-1)};History.prototype.restore=function(){try{if((window.location.hash=="")||(window.location.hash=="#")){return false}var A=window.location.hash.replace("#","").split(".");var C=[];for(var B=0;B<A.length;B++){var F=parseInt(A[B],36);if(!tale.has(F)){return false}var E=(B==A.length-1)?"":"offscreen";C.unshift(this.display(F,null,E))}return true}catch(D){return false}};History.prototype.watchHash=function(){if(window.location.hash!=this.hash){if((window.location.hash!="")&&(window.location.hash!="#")){this.history=[{passage:null,variables:{}}];removeChildren($("passages"));$("passages").style.visibility="hidden";if(!this.restore()){alert("The passage you had previously visited could not be found.")}$("passages").style.visibility="visible"}else{window.location.reload()}this.hash=window.location.hash}};var version={major:2,minor:0,revision:0,date:new Date("July 30, 2007"),extensions:{}};var tale,state;var macros={};function main(){tale=new Tale();document.title=tale.title;setPageElement("storyTitle","StoryTitle","Untitled Story");if(tale.has("StoryAuthor")){$("titleSeparator").innerHTML="<br />";setPageElement("storyAuthor","StoryAuthor","")}if(tale.has("StoryMenu")){$("storyMenu").style.display="block";setPageElement("storyMenu","StoryMenu","")}for(macro in macros){if(typeof macro.init=="function"){macro.init()}}var styles=tale.lookup("tags","stylesheet");for(var i=0;i<styles.length;i++){addStyle(styles[i].text)}var scripts=tale.lookup("tags","script");for(var i=0;i<scripts.length;i++){try{eval(scripts[i].text)}catch(e){alert("There is a technical problem with this story ("+scripts[i].title+": "+e.message+"). You may be able to continue reading, but all parts of the story may not work properly.")}}state=new History();state.init()}Interface={init:function(){main();$("snapback").onclick=Interface.showSnapback;$("restart").onclick=Interface.restart;$("share").onclick=Interface.showShare},restart:function(){if(confirm("Are you sure you want to restart this story?")){state.restart()}},showShare:function(A){Interface.hideAllMenus();Interface.showMenu(A,$("shareMenu"))},showSnapback:function(A){Interface.hideAllMenus();Interface.buildSnapback();Interface.showMenu(A,$("snapbackMenu"))},buildSnapback:function(){var C=false;removeChildren($("snapbackMenu"));for(var A=state.history.length-1;A>=0;A--){if(state.history[A].passage&&state.history[A].passage.tags.indexOf("bookmark")!=-1){var B=document.createElement("div");B.hash=state.history[A].hash;B.onclick=function(){window.location.hash=this.hash};B.innerHTML=state.history[A].passage.excerpt();$("snapbackMenu").appendChild(B);C=true}}if(!C){var B=document.createElement("div");B.innerHTML="<i>No passages available</i>";$("snapbackMenu").appendChild(B)}},hideAllMenus:function(){$("shareMenu").style.display="none";$("snapbackMenu").style.display="none"},showMenu:function(B,A){if(!B){B=window.event}var C={x:0,y:0};if(B.pageX||B.pageY){C.x=B.pageX;C.y=B.pageY}else{if(B.clientX||B.clientY){C.x=B.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;C.y=B.clientY+document.body.scrollTop+document.documentElement.scrollTop}}A.style.top=C.y+"px";A.style.left=C.x+"px";A.style.display="block";document.onclick=Interface.hideAllMenus;B.cancelBubble=true;if(B.stopPropagation){B.stopPropagation()}}};window.onload=Interface.init;version.extensions.backMacro={major:1,minor:0,revision:0};macros.back={handler:function(A,B,E){var D="";if(E[0]){for(var C=0;C<state.history.length;C++){if(state.history[C].passage.title==E[0]){D=state.history[C].hash;break}}if(D==""){throwError(A,"can't find passage \""+E[0]+'" in history');return }}else{D=state.history[1].hash}el=document.createElement("a");el.className="back";el.href=D;el.innerHTML="<b>&laquo;</b> Back";A.appendChild(el)}};version.extensions.displayMacro={major:1,minor:0,revision:0};macros.display={handler:function(A,B,C){new Wikifier(A,tale.get(C[0]).text)}};version.extensions.actionsMacro={major:1,minor:1,revision:0};macros.actions={clicked:new Object(),handler:function(A,F,G){var E=insertElement(A,"ul");for(var B=0;B<G.length;B++){if(macros.actions.clicked[G[B]]){continue}var D=insertElement(E,"li");var C=Wikifier.createInternalLink(D,G[B]);insertText(C,G[B]);C.onclick=function(){macros.actions.clicked[this.id]=true;state.display(this.id,C)}}}};version.extensions.printMacro={major:1,minor:1,revision:0};macros.print={handler:function(place,macroName,params,parser){try{var output=eval(parser.fullArgs());if(output){new Wikifier(place,output.toString())}}catch(e){throwError(place,"bad expression: "+e.message)}}};version.extensions.setMacro={major:1,minor:1,revision:0};macros.set={handler:function(A,B,C,D){macros.set.run(D.fullArgs())},run:function(expression){try{return eval(Wikifier.parse(expression))}catch(e){throwError(place,"bad expression: "+e.message)}}};version.extensions.ifMacros={major:1,minor:0,revision:0};macros["if"]={handler:function(place,macroName,params,parser){var condition=parser.fullArgs();var srcOffset=parser.source.indexOf(">>",parser.matchStart)+2;var src=parser.source.slice(srcOffset);var endPos=-1;var trueClause="";var falseClause="";for(var i=0,nesting=1,currentClause=true;i<src.length;i++){if(src.substr(i,9)=="<<endif>>"){nesting--;if(nesting==0){endPos=srcOffset+i+9;break}}if((src.substr(i,8)=="<<else>>")&&(nesting==1)){currentClause="false";i+=8}if(src.substr(i,5)=="<<if "){nesting++}if(currentClause==true){trueClause+=src.charAt(i)}else{falseClause+=src.charAt(i)}}try{if(eval(condition)){new Wikifier(place,trueClause.trim())}else{new Wikifier(place,falseClause.trim())}if(endPos!=-1){parser.nextMatch=endPos}else{throwError(place,"can't find matching endif")}}catch(e){throwError(place,"bad condition: "+e.message)}}};macros["else"]=macros.endif={handler:function(){}};version.extensions.rememberMacro={major:1,minor:0,revision:0};macros.remember={handler:function(place,macroName,params,parser){var statement=parser.fullArgs();var expire=new Date();var variable,value;macros.set.run(statement);variable=statement.match(new RegExp(Wikifier.parse("$")+"(\\w+)","i"))[1];value=eval(Wikifier.parse("$"+variable));switch(typeof value){case"string":value='"'+value.replace(/"/g,'\\"')+'"';break;case"number":case"boolean":break;default:throwError(place,"can't remember $"+variable+" ("+(typeof value)+")");return }expire.setYear(expire.getFullYear()+1);document.cookie=macros.remember.prefix+variable+"="+value+"; expires="+expire.toGMTString()},init:function(){if(tale.has("StoryTitle")){macros.remember.prefix=tale.get("StoryTitle").text+"_"}else{macros.remember.prefix="__jonah_"}var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){var bits=cookies[i].split("=");if(bits[0].trim().indexOf(this.prefix)==0){var statement=cookies[i].replace(this.prefix,"$");eval(Wikifier.parse(statement))}}}};version.extensions.SilentlyMacro={major:1,minor:0,revision:0};macros.silently={handler:function(G,E,F,B){var H=insertElement(null,"div");var J=B.source.indexOf(">>",B.matchStart)+2;var A=B.source.slice(J);var D=-1;var C="";for(var I=0;I<A.length;I++){if(A.substr(I,15)=="<<endsilently>>"){D=J+I+15}else{C+=A.charAt(I)}}if(D!=-1){new Wikifier(H,C);B.nextMatch=D}else{throwError(G,"can't find matching endsilently")}delete H}};macros.endsilently={handler:function(){}};function Passage(C,B,A){this.title=C;if(B){this.id=A;this.initialText=this.text=Passage.unescapeLineBreaks(B.firstChild?B.firstChild.nodeValue:"");this.tags=B.getAttribute("tags");if(typeof this.tags=="string"){this.tags=this.tags.readBracketedList()}else{this.tags=[]}}else{this.initialText=this.text="@@This passage does not exist.@@";this.tags=[]}}Passage.prototype.render=function(){var B=insertElement(null,"div","passage"+this.title,"passage");B.style.visibility="hidden";insertElement(B,"div","","header");var A=insertElement(B,"div","","content");new Wikifier(A,this.text);insertElement(B,"div","","footer");return B};Passage.prototype.reset=function(){this.text=this.initialText};Passage.prototype.excerpt=function(){var B=this.text.replace(/<<.*?>>/g,"");B=B.replace(/!.*?\n/g,"");B=B.replace(/[\[\]\/]/g,"");var A=B.match(/(.*?\s.*?\s.*?\s.*?\s.*?\s.*?\s.*?)\s/);return A[1]+"..."};Passage.unescapeLineBreaks=function(A){if(A&&A!=""){return A.replace(/\\n/mg,"\n").replace(/\\/mg,"\\").replace(/\r/mg,"")}else{return""}};function Tale(){this.passages={};if(document.normalize){document.normalize()}var A=$("storeArea").childNodes;for(var B=0;B<A.length;B++){var C=A[B];if(C.getAttribute&&(tiddlerTitle=C.getAttribute("tiddler"))){this.passages[tiddlerTitle]=new Passage(tiddlerTitle,C,B)}}this.title="Sugarcane";if(this.passages.StoryTitle){this.title=this.passages.StoryTitle.text}}Tale.prototype.has=function(A){if(typeof A=="string"){return(this.passages[A]!=null)}else{for(i in this.passages){if(this.passages[i].id==A){return true}}return false}};Tale.prototype.get=function(A){if(typeof A=="string"){return this.passages[A]||new Passage(A)}else{for(i in this.passages){if(this.passages[i].id==A){return this.passages[i]}}}};Tale.prototype.lookup=function(H,G,A){var D=[];for(var C in this.passages){var F=this.passages[C];var E=false;for(var B=0;B<F[H].length;B++){if(F[H][B]==G){D.push(F)}}}if(!A){A="title"}D.sort(function(J,I){if(J[A]==I[A]){return(0)}else{return(J[A]<I[A])?-1:+1}});return D};Tale.prototype.reset=function(){for(i in this.passages){this.passages[i].reset()}};function Wikifier(A,B){this.source=B;this.output=A;this.nextMatch=0;this.assembleFormatterMatches(Wikifier.formatters);this.subWikify(this.output)}Wikifier.prototype.assembleFormatterMatches=function(A){this.formatters=[];var B=[];for(var C=0;C<A.length;C++){B.push("("+A[C].match+")");this.formatters.push(A[C])}this.formatterRegExp=new RegExp(B.join("|"),"mg")};Wikifier.prototype.subWikify=function(C,B){var A=this.output;this.output=C;var F=B?new RegExp("("+B+")","mg"):null;do{this.formatterRegExp.lastIndex=this.nextMatch;if(F){F.lastIndex=this.nextMatch}var G=this.formatterRegExp.exec(this.source);var E=F?F.exec(this.source):null;if(E&&(!G||E.index<=G.index)){if(E.index>this.nextMatch){this.outputText(this.output,this.nextMatch,E.index)}this.matchStart=E.index;this.matchLength=E[1].length;this.matchText=E[1];this.nextMatch=E.index+E[1].length;this.output=A;return }else{if(G){if(G.index>this.nextMatch){this.outputText(this.output,this.nextMatch,G.index)}this.matchStart=G.index;this.matchLength=G[0].length;this.matchText=G[0];this.nextMatch=this.formatterRegExp.lastIndex;var H=-1;for(var D=1;D<G.length;D++){if(G[D]){matchingFormatter=D-1}}if(matchingFormatter!=-1){this.formatters[matchingFormatter].handler(this)}}}}while(E||G);if(this.nextMatch<this.source.length){this.outputText(this.output,this.nextMatch,this.source.length);this.nextMatch=this.source.length}this.output=A};Wikifier.prototype.outputText=function(A,C,B){insertText(A,this.source.substring(C,B))};Wikifier.prototype.fullArgs=function(){var B=this.source.indexOf(" ",this.matchStart);var A=this.source.indexOf(">>",this.matchStart);return Wikifier.parse(this.source.slice(B,A))};Wikifier.parse=function(B){var A=B.replace(/\$/g,"state.history[0].variables.");A=A.replace(/\beq\b/gi," == ");A=A.replace(/\bneq\b/gi," != ");A=A.replace(/\bgt\b/gi," > ");A=A.replace(/\beq\b/gi," == ");A=A.replace(/\bneq\b/gi," != ");A=A.replace(/\bgt\b/gi," > ");A=A.replace(/\bgte\b/gi," >= ");A=A.replace(/\blt\b/gi," < ");A=A.replace(/\blte\b/gi," <= ");A=A.replace(/\band\b/gi," && ");A=A.replace(/\bor\b/gi," || ");A=A.replace(/\bnot\b/gi," ! ");return A};Wikifier.formatHelpers={charFormatHelper:function(A){var B=insertElement(A.output,this.element);A.subWikify(B,this.terminator)},inlineCssHelper:function(F){var H=[];var A="(?:("+Wikifier.textPrimitives.anyLetter+"+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:("+Wikifier.textPrimitives.anyLetter+"+):([^;\\|\\n]+);)";var B=new RegExp(A,"mg");var C=false;do{B.lastIndex=F.nextMatch;var D=B.exec(F.source);var E=D&&D.index==F.nextMatch;if(E){var I,G;C=true;if(D[1]){I=D[1].unDash();G=D[2]}else{I=D[3].unDash();G=D[4]}switch(I){case"bgcolor":I="backgroundColor";break}H.push({style:I,value:G});F.nextMatch=D.index+D[0].length}}while(E);return H},monospacedByLineHelper:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart){var E=C[1];if(navigator.userAgent.indexOf("msie")!=-1&&navigator.userAgent.indexOf("opera")==-1){E=E.replace(/\n/g,"\r")}var D=insertElement(A.output,"pre",null,null,E);A.nextMatch=C.index+C[0].length}}};Wikifier.formatters=[{name:"table",match:"^\\|(?:[^\\n]*)\\|(?:[fhc]?)$",lookahead:"^\\|([^\\n]*)\\|([fhc]?)$",rowTerminator:"\\|(?:[fhc]?)$\\n?",cellPattern:"(?:\\|([^\\n\\|]*)\\|)|(\\|[fhc]?$\\n?)",cellTerminator:"(?:\\x20*)\\|",rowTypes:{c:"caption",h:"thead","":"tbody",f:"tfoot"},handler:function(H){var J=insertElement(H.output,"table");H.nextMatch=H.matchStart;var C=new RegExp(this.lookahead,"mg");var D=null,A;var K,E;var I=[];var G=0;do{C.lastIndex=H.nextMatch;var F=C.exec(H.source);var B=F&&F.index==H.nextMatch;if(B){A=F[2];if(A!=D){K=insertElement(J,this.rowTypes[A])}D=A;if(D=="c"){if(G==0){K.setAttribute("align","top")}else{K.setAttribute("align","bottom")}H.nextMatch=H.nextMatch+1;H.subWikify(K,this.rowTerminator)}else{E=insertElement(K,"tr");this.rowHandler(H,E,I)}G++}}while(B)},rowHandler:function(G,D,K){var A=0;var I=1;var C=new RegExp(this.cellPattern,"mg");do{C.lastIndex=G.nextMatch;var E=C.exec(G.source);matched=E&&E.index==G.nextMatch;if(matched){if(E[1]=="~"){var J=K[A];if(J){J.rowCount++;J.element.setAttribute("rowSpan",J.rowCount);J.element.setAttribute("rowspan",J.rowCount);J.element.valign="center"}G.nextMatch=E.index+E[0].length-1}else{if(E[1]==">"){I++;G.nextMatch=E.index+E[0].length-1}else{if(E[2]){G.nextMatch=E.index+E[0].length;break}else{var B=false,F=false;G.nextMatch++;var M=Wikifier.formatHelpers.inlineCssHelper(G);while(G.source.substr(G.nextMatch,1)==" "){B=true;G.nextMatch++}var H;if(G.source.substr(G.nextMatch,1)=="!"){H=insertElement(D,"th");G.nextMatch++}else{H=insertElement(D,"td")}K[A]={rowCount:1,element:H};lastColCount=1;lastColElement=H;if(I>1){H.setAttribute("colSpan",I);H.setAttribute("colspan",I);I=1}for(var L=0;L<M.length;L++){H.style[M[L].style]=M[L].value}G.subWikify(H,this.cellTerminator);if(G.matchText.substr(G.matchText.length-2,1)==" "){F=true}if(B&&F){H.align="center"}else{if(B){H.align="right"}else{if(F){H.align="left"}}}G.nextMatch=G.nextMatch-1}}}A++}}while(matched)}},{name:"rule",match:"^----$\\n?",handler:function(A){insertElement(A.output,"hr")}},{name:"emdash",match:"--",handler:function(A){var B=insertElement(A.output,"span");B.innerHTML="&mdash;"}},{name:"heading",match:"^!{1,5}",terminator:"\\n",handler:function(A){var B=insertElement(A.output,"h"+A.matchLength);A.subWikify(B,this.terminator)}},{name:"monospacedByLine",match:"^\\{\\{\\{\\n",lookahead:"^\\{\\{\\{\\n((?:^[^\\n]*\\n)+?)(^\\}\\}\\}$\\n?)",handler:Wikifier.formatHelpers.monospacedByLineHelper},{name:"monospacedByLineForPlugin",match:"^//\\{\\{\\{\\n",lookahead:"^//\\{\\{\\{\\n\\n*((?:^[^\\n]*\\n)+?)(\\n*^//\\}\\}\\}$\\n?)",handler:Wikifier.formatHelpers.monospacedByLineHelper},{name:"wikifyCommentForPlugin",match:"^/\\*\\*\\*\\n",terminator:"^\\*\\*\\*/\\n",handler:function(A){A.subWikify(A.output,this.terminator)}},{name:"quoteByBlock",match:"^<<<\\n",terminator:"^<<<\\n",handler:function(A){var B=insertElement(A.output,"blockquote");A.subWikify(B,this.terminator)}},{name:"quoteByLine",match:"^>+",terminator:"\\n",element:"blockquote",handler:function(C){var E=new RegExp(this.match,"mg");var D=[C.output];var H=0;var B=C.matchLength;var G;do{if(B>H){for(G=H;G<B;G++){D.push(insertElement(D[D.length-1],this.element))}}else{if(B<H){for(G=H;G>B;G--){D.pop()}}}H=B;C.subWikify(D[D.length-1],this.terminator);insertElement(D[D.length-1],"br");E.lastIndex=C.nextMatch;var F=E.exec(C.source);var A=F&&F.index==C.nextMatch;if(A){B=F[0].length;C.nextMatch+=F[0].length}}while(A)}},{name:"list",match:"^(?:(?:\\*+)|(?:#+))",lookahead:"^(?:(\\*+)|(#+))",terminator:"\\n",outerElement:"ul",itemElement:"li",handler:function(I){var B=new RegExp(this.lookahead,"mg");I.nextMatch=I.matchStart;var E=[I.output];var J=null,C;var G=0,D;var K;do{B.lastIndex=I.nextMatch;var F=B.exec(I.source);var A=F&&F.index==I.nextMatch;if(A){if(F[1]){C="ul"}if(F[2]){C="ol"}D=F[0].length;I.nextMatch+=F[0].length;if(D>G){for(K=G;K<D;K++){E.push(insertElement(E[E.length-1],C))}}else{if(D<G){for(K=G;K>D;K--){E.pop()}}else{if(D==G&&C!=J){E.pop();E.push(insertElement(E[E.length-1],C))}}}G=D;J=C;var H=insertElement(E[E.length-1],"li");I.subWikify(H,this.terminator)}}while(A)}},{name:"prettyLink",match:"\\[\\[",lookahead:"\\[\\[([^\\|\\]]*?)(?:(\\]\\])|(\\|(.*?)\\]\\]))",terminator:"\\|",handler:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart&&C[2]){var D=Wikifier.createInternalLink(A.output,C[1]);A.outputText(D,A.nextMatch,A.nextMatch+C[1].length);A.nextMatch+=C[1].length+2}else{if(C&&C.index==A.matchStart&&C[3]){var E;if(tale.has(C[4])){E=Wikifier.createInternalLink(A.output,C[4])}else{E=Wikifier.createExternalLink(A.output,C[4])}A.outputText(E,A.nextMatch,A.nextMatch+C[1].length);A.nextMatch=C.index+C[0].length}}}},{name:"urlLink",match:"(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)",handler:function(A){var B=Wikifier.createExternalLink(A.output,A.matchText);A.outputText(B,A.matchStart,A.nextMatch)}},{name:"image",match:"\\[(?:[<]{0,1})(?:[>]{0,1})[Ii][Mm][Gg]\\[",lookahead:"\\[([<]{0,1})([>]{0,1})[Ii][Mm][Gg]\\[(?:([^\\|\\]]+)\\|)?([^\\[\\]\\|]+)\\](?:\\[([^\\]]*)\\]?)?(\\])",handler:function(A){var C=new RegExp(this.lookahead,"mg");C.lastIndex=A.matchStart;var D=C.exec(A.source);if(D&&D.index==A.matchStart){var E=A.output;if(D[5]){if(tale.has(D[5])){E=Wikifier.createInternalLink(A.output,D[5])}else{E=Wikifier.createExternalLink(A.output,D[5])}}var B=insertElement(E,"img");if(D[1]){B.align="left"}else{if(D[2]){B.align="right"}}if(D[3]){B.title=D[3]}B.src=D[4];A.nextMatch=D.index+D[0].length}}},{name:"macro",match:"<<",lookahead:"<<([^>\\s]+)(?:\\s*)([^>]*)>>",handler:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart&&C[1]){var F=C[2].readMacroParams();A.nextMatch=C.index+C[0].length;try{var D=macros[C[1]];if(D&&D.handler){D.handler(A.output,C[1],F,A)}else{insertElement(A.output,"span",null,"marked","macro not found: "+C[1])}}catch(E){throwError(A.output,"Error executing macro "+C[1]+": "+E.toString())}}}},{name:"html",match:"<[Hh][Tt][Mm][Ll]>",lookahead:"<[Hh][Tt][Mm][Ll]>((?:.|\\n)*?)</[Hh][Tt][Mm][Ll]>",handler:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart){var D=insertElement(A.output,"span");D.innerHTML=C[1];A.nextMatch=C.index+C[0].length}}},{name:"commentByBlock",match:"/%",lookahead:"/%((?:.|\\n)*?)%/",handler:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart){A.nextMatch=C.index+C[0].length}}},{name:"boldByChar",match:"''",terminator:"''",element:"strong",handler:Wikifier.formatHelpers.charFormatHelper},{name:"strikeByChar",match:"==",terminator:"==",element:"strike",handler:Wikifier.formatHelpers.charFormatHelper},{name:"underlineByChar",match:"__",terminator:"__",element:"u",handler:Wikifier.formatHelpers.charFormatHelper},{name:"italicByChar",match:"//",terminator:"//",element:"em",handler:Wikifier.formatHelpers.charFormatHelper},{name:"subscriptByChar",match:"~~",terminator:"~~",element:"sub",handler:Wikifier.formatHelpers.charFormatHelper},{name:"superscriptByChar",match:"\\^\\^",terminator:"\\^\\^",element:"sup",handler:Wikifier.formatHelpers.charFormatHelper},{name:"monospacedByChar",match:"\\{\\{\\{",lookahead:"\\{\\{\\{((?:.|\\n)*?)\\}\\}\\}",handler:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart){var D=insertElement(A.output,"code",null,null,C[1]);A.nextMatch=C.index+C[0].length}}},{name:"styleByChar",match:"@@",terminator:"@@",lookahead:"(?:([^\\(@]+)\\(([^\\)]+)(?:\\):))|(?:([^:@]+):([^;]+);)",handler:function(A){var D=insertElement(A.output,"span",null,null,null);var C=Wikifier.formatHelpers.inlineCssHelper(A);if(C.length==0){D.className="marked"}else{for(var B=0;B<C.length;B++){D.style[C[B].style]=C[B].value}}A.subWikify(D,this.terminator)}},{name:"lineBreak",match:"\\n",handler:function(A){insertElement(A.output,"br")}}];Wikifier.textPrimitives={anyDigit:"[0-9]",anyNumberChar:"[0-9\\.E]",urlPattern:"(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)"};Wikifier.createInternalLink=function(A,C){var B=insertElement(A,"a",C);B.href="javascript:void(0)";if(tale.has(C)){B.className="internalLink"}else{B.className="brokenLink"}B.onclick=function(){state.display(C,B)};if(A){A.appendChild(B)}return B};Wikifier.createExternalLink=function(A,B){var C=insertElement(A,"a");C.href=B;C.className="externalLink";C.target="_blank";if(A){A.appendChild(C)}return C};if(!((new RegExp("[\u0150\u0170]","g")).test("\u0150"))){Wikifier.textPrimitives.upperLetter="[A-Z\u00c0-\u00de]";Wikifier.textPrimitives.lowerLetter="[a-z\u00df-\u00ff_0-9\\-]";Wikifier.textPrimitives.anyLetter="[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-]"}else{Wikifier.textPrimitives.upperLetter="[A-Z\u00c0-\u00de\u0150\u0170]";Wikifier.textPrimitives.lowerLetter="[a-z\u00df-\u00ff_0-9\\-\u0151\u0171]";Wikifier.textPrimitives.anyLetter="[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-\u0150\u0170\u0151\u0171]"}function Wikifier(A,B){this.source=B;this.output=A;this.nextMatch=0;this.assembleFormatterMatches(Wikifier.formatters);this.subWikify(this.output)}Wikifier.prototype.assembleFormatterMatches=function(A){this.formatters=[];var B=[];for(var C=0;C<A.length;C++){B.push("("+A[C].match+")");this.formatters.push(A[C])}this.formatterRegExp=new RegExp(B.join("|"),"mg")};Wikifier.prototype.subWikify=function(C,B){var A=this.output;this.output=C;var F=B?new RegExp("("+B+")","mg"):null;do{this.formatterRegExp.lastIndex=this.nextMatch;if(F){F.lastIndex=this.nextMatch}var G=this.formatterRegExp.exec(this.source);var E=F?F.exec(this.source):null;if(E&&(!G||E.index<=G.index)){if(E.index>this.nextMatch){this.outputText(this.output,this.nextMatch,E.index)}this.matchStart=E.index;this.matchLength=E[1].length;this.matchText=E[1];this.nextMatch=E.index+E[1].length;this.output=A;return }else{if(G){if(G.index>this.nextMatch){this.outputText(this.output,this.nextMatch,G.index)}this.matchStart=G.index;this.matchLength=G[0].length;this.matchText=G[0];this.nextMatch=this.formatterRegExp.lastIndex;var H=-1;for(var D=1;D<G.length;D++){if(G[D]){matchingFormatter=D-1}}if(matchingFormatter!=-1){this.formatters[matchingFormatter].handler(this)}}}}while(E||G);if(this.nextMatch<this.source.length){this.outputText(this.output,this.nextMatch,this.source.length);this.nextMatch=this.source.length}this.output=A};Wikifier.prototype.outputText=function(A,C,B){insertText(A,this.source.substring(C,B))};Wikifier.prototype.fullArgs=function(){var B=this.source.indexOf(" ",this.matchStart);var A=this.source.indexOf(">>",this.matchStart);return Wikifier.parse(this.source.slice(B,A))};Wikifier.parse=function(B){var A=B.replace(/\$/g,"state.history[0].variables.");A=A.replace(/\beq\b/gi," == ");A=A.replace(/\bneq\b/gi," != ");A=A.replace(/\bgt\b/gi," > ");A=A.replace(/\beq\b/gi," == ");A=A.replace(/\bneq\b/gi," != ");A=A.replace(/\bgt\b/gi," > ");A=A.replace(/\bgte\b/gi," >= ");A=A.replace(/\blt\b/gi," < ");A=A.replace(/\blte\b/gi," <= ");A=A.replace(/\band\b/gi," && ");A=A.replace(/\bor\b/gi," || ");A=A.replace(/\bnot\b/gi," ! ");return A};Wikifier.formatHelpers={charFormatHelper:function(A){var B=insertElement(A.output,this.element);A.subWikify(B,this.terminator)},inlineCssHelper:function(F){var H=[];var A="(?:("+Wikifier.textPrimitives.anyLetter+"+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:("+Wikifier.textPrimitives.anyLetter+"+):([^;\\|\\n]+);)";var B=new RegExp(A,"mg");var C=false;do{B.lastIndex=F.nextMatch;var D=B.exec(F.source);var E=D&&D.index==F.nextMatch;if(E){var I,G;C=true;if(D[1]){I=D[1].unDash();G=D[2]}else{I=D[3].unDash();G=D[4]}switch(I){case"bgcolor":I="backgroundColor";break}H.push({style:I,value:G});F.nextMatch=D.index+D[0].length}}while(E);return H},monospacedByLineHelper:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart){var E=C[1];if(navigator.userAgent.indexOf("msie")!=-1&&navigator.userAgent.indexOf("opera")==-1){E=E.replace(/\n/g,"\r")}var D=insertElement(A.output,"pre",null,null,E);A.nextMatch=C.index+C[0].length}}};Wikifier.formatters=[{name:"table",match:"^\\|(?:[^\\n]*)\\|(?:[fhc]?)$",lookahead:"^\\|([^\\n]*)\\|([fhc]?)$",rowTerminator:"\\|(?:[fhc]?)$\\n?",cellPattern:"(?:\\|([^\\n\\|]*)\\|)|(\\|[fhc]?$\\n?)",cellTerminator:"(?:\\x20*)\\|",rowTypes:{c:"caption",h:"thead","":"tbody",f:"tfoot"},handler:function(H){var J=insertElement(H.output,"table");H.nextMatch=H.matchStart;var C=new RegExp(this.lookahead,"mg");var D=null,A;var K,E;var I=[];var G=0;do{C.lastIndex=H.nextMatch;var F=C.exec(H.source);var B=F&&F.index==H.nextMatch;if(B){A=F[2];if(A!=D){K=insertElement(J,this.rowTypes[A])}D=A;if(D=="c"){if(G==0){K.setAttribute("align","top")}else{K.setAttribute("align","bottom")}H.nextMatch=H.nextMatch+1;H.subWikify(K,this.rowTerminator)}else{E=insertElement(K,"tr");this.rowHandler(H,E,I)}G++}}while(B)},rowHandler:function(G,D,K){var A=0;var I=1;var C=new RegExp(this.cellPattern,"mg");do{C.lastIndex=G.nextMatch;var E=C.exec(G.source);matched=E&&E.index==G.nextMatch;if(matched){if(E[1]=="~"){var J=K[A];if(J){J.rowCount++;J.element.setAttribute("rowSpan",J.rowCount);J.element.setAttribute("rowspan",J.rowCount);J.element.valign="center"}G.nextMatch=E.index+E[0].length-1}else{if(E[1]==">"){I++;G.nextMatch=E.index+E[0].length-1}else{if(E[2]){G.nextMatch=E.index+E[0].length;break}else{var B=false,F=false;G.nextMatch++;var M=Wikifier.formatHelpers.inlineCssHelper(G);while(G.source.substr(G.nextMatch,1)==" "){B=true;G.nextMatch++}var H;if(G.source.substr(G.nextMatch,1)=="!"){H=insertElement(D,"th");G.nextMatch++}else{H=insertElement(D,"td")}K[A]={rowCount:1,element:H};lastColCount=1;lastColElement=H;if(I>1){H.setAttribute("colSpan",I);H.setAttribute("colspan",I);I=1}for(var L=0;L<M.length;L++){H.style[M[L].style]=M[L].value}G.subWikify(H,this.cellTerminator);if(G.matchText.substr(G.matchText.length-2,1)==" "){F=true}if(B&&F){H.align="center"}else{if(B){H.align="right"}else{if(F){H.align="left"}}}G.nextMatch=G.nextMatch-1}}}A++}}while(matched)}},{name:"rule",match:"^----$\\n?",handler:function(A){insertElement(A.output,"hr")}},{name:"emdash",match:"--",handler:function(A){var B=insertElement(A.output,"span");B.innerHTML="&mdash;"}},{name:"heading",match:"^!{1,5}",terminator:"\\n",handler:function(A){var B=insertElement(A.output,"h"+A.matchLength);A.subWikify(B,this.terminator)}},{name:"monospacedByLine",match:"^\\{\\{\\{\\n",lookahead:"^\\{\\{\\{\\n((?:^[^\\n]*\\n)+?)(^\\}\\}\\}$\\n?)",handler:Wikifier.formatHelpers.monospacedByLineHelper},{name:"monospacedByLineForPlugin",match:"^//\\{\\{\\{\\n",lookahead:"^//\\{\\{\\{\\n\\n*((?:^[^\\n]*\\n)+?)(\\n*^//\\}\\}\\}$\\n?)",handler:Wikifier.formatHelpers.monospacedByLineHelper},{name:"wikifyCommentForPlugin",match:"^/\\*\\*\\*\\n",terminator:"^\\*\\*\\*/\\n",handler:function(A){A.subWikify(A.output,this.terminator)}},{name:"quoteByBlock",match:"^<<<\\n",terminator:"^<<<\\n",handler:function(A){var B=insertElement(A.output,"blockquote");A.subWikify(B,this.terminator)}},{name:"quoteByLine",match:"^>+",terminator:"\\n",element:"blockquote",handler:function(C){var E=new RegExp(this.match,"mg");var D=[C.output];var H=0;var B=C.matchLength;var G;do{if(B>H){for(G=H;G<B;G++){D.push(insertElement(D[D.length-1],this.element))}}else{if(B<H){for(G=H;G>B;G--){D.pop()}}}H=B;C.subWikify(D[D.length-1],this.terminator);insertElement(D[D.length-1],"br");E.lastIndex=C.nextMatch;var F=E.exec(C.source);var A=F&&F.index==C.nextMatch;if(A){B=F[0].length;C.nextMatch+=F[0].length}}while(A)}},{name:"list",match:"^(?:(?:\\*+)|(?:#+))",lookahead:"^(?:(\\*+)|(#+))",terminator:"\\n",outerElement:"ul",itemElement:"li",handler:function(I){var B=new RegExp(this.lookahead,"mg");I.nextMatch=I.matchStart;var E=[I.output];var J=null,C;var G=0,D;var K;do{B.lastIndex=I.nextMatch;var F=B.exec(I.source);var A=F&&F.index==I.nextMatch;if(A){if(F[1]){C="ul"}if(F[2]){C="ol"}D=F[0].length;I.nextMatch+=F[0].length;if(D>G){for(K=G;K<D;K++){E.push(insertElement(E[E.length-1],C))}}else{if(D<G){for(K=G;K>D;K--){E.pop()}}else{if(D==G&&C!=J){E.pop();E.push(insertElement(E[E.length-1],C))}}}G=D;J=C;var H=insertElement(E[E.length-1],"li");I.subWikify(H,this.terminator)}}while(A)}},{name:"prettyLink",match:"\\[\\[",lookahead:"\\[\\[([^\\|\\]]*?)(?:(\\]\\])|(\\|(.*?)\\]\\]))",terminator:"\\|",handler:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart&&C[2]){var D=Wikifier.createInternalLink(A.output,C[1]);A.outputText(D,A.nextMatch,A.nextMatch+C[1].length);A.nextMatch+=C[1].length+2}else{if(C&&C.index==A.matchStart&&C[3]){var E;if(tale.has(C[4])){E=Wikifier.createInternalLink(A.output,C[4])}else{E=Wikifier.createExternalLink(A.output,C[4])}A.outputText(E,A.nextMatch,A.nextMatch+C[1].length);A.nextMatch=C.index+C[0].length}}}},{name:"urlLink",match:"(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)",handler:function(A){var B=Wikifier.createExternalLink(A.output,A.matchText);A.outputText(B,A.matchStart,A.nextMatch)}},{name:"image",match:"\\[(?:[<]{0,1})(?:[>]{0,1})[Ii][Mm][Gg]\\[",lookahead:"\\[([<]{0,1})([>]{0,1})[Ii][Mm][Gg]\\[(?:([^\\|\\]]+)\\|)?([^\\[\\]\\|]+)\\](?:\\[([^\\]]*)\\]?)?(\\])",handler:function(A){var C=new RegExp(this.lookahead,"mg");C.lastIndex=A.matchStart;var D=C.exec(A.source);if(D&&D.index==A.matchStart){var E=A.output;if(D[5]){if(tale.has(D[5])){E=Wikifier.createInternalLink(A.output,D[5])}else{E=Wikifier.createExternalLink(A.output,D[5])}}var B=insertElement(E,"img");if(D[1]){B.align="left"}else{if(D[2]){B.align="right"}}if(D[3]){B.title=D[3]}B.src=D[4];A.nextMatch=D.index+D[0].length}}},{name:"macro",match:"<<",lookahead:"<<([^>\\s]+)(?:\\s*)([^>]*)>>",handler:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart&&C[1]){var F=C[2].readMacroParams();A.nextMatch=C.index+C[0].length;try{var D=macros[C[1]];if(D&&D.handler){D.handler(A.output,C[1],F,A)}else{insertElement(A.output,"span",null,"marked","macro not found: "+C[1])}}catch(E){throwError(A.output,"Error executing macro "+C[1]+": "+E.toString())}}}},{name:"html",match:"<[Hh][Tt][Mm][Ll]>",lookahead:"<[Hh][Tt][Mm][Ll]>((?:.|\\n)*?)</[Hh][Tt][Mm][Ll]>",handler:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart){var D=insertElement(A.output,"span");D.innerHTML=C[1];A.nextMatch=C.index+C[0].length}}},{name:"commentByBlock",match:"/%",lookahead:"/%((?:.|\\n)*?)%/",handler:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart){A.nextMatch=C.index+C[0].length}}},{name:"boldByChar",match:"''",terminator:"''",element:"strong",handler:Wikifier.formatHelpers.charFormatHelper},{name:"strikeByChar",match:"==",terminator:"==",element:"strike",handler:Wikifier.formatHelpers.charFormatHelper},{name:"underlineByChar",match:"__",terminator:"__",element:"u",handler:Wikifier.formatHelpers.charFormatHelper},{name:"italicByChar",match:"//",terminator:"//",element:"em",handler:Wikifier.formatHelpers.charFormatHelper},{name:"subscriptByChar",match:"~~",terminator:"~~",element:"sub",handler:Wikifier.formatHelpers.charFormatHelper},{name:"superscriptByChar",match:"\\^\\^",terminator:"\\^\\^",element:"sup",handler:Wikifier.formatHelpers.charFormatHelper},{name:"monospacedByChar",match:"\\{\\{\\{",lookahead:"\\{\\{\\{((?:.|\\n)*?)\\}\\}\\}",handler:function(A){var B=new RegExp(this.lookahead,"mg");B.lastIndex=A.matchStart;var C=B.exec(A.source);if(C&&C.index==A.matchStart){var D=insertElement(A.output,"code",null,null,C[1]);A.nextMatch=C.index+C[0].length}}},{name:"styleByChar",match:"@@",terminator:"@@",lookahead:"(?:([^\\(@]+)\\(([^\\)]+)(?:\\):))|(?:([^:@]+):([^;]+);)",handler:function(A){var D=insertElement(A.output,"span",null,null,null);var C=Wikifier.formatHelpers.inlineCssHelper(A);if(C.length==0){D.className="marked"}else{for(var B=0;B<C.length;B++){D.style[C[B].style]=C[B].value}}A.subWikify(D,this.terminator)}},{name:"lineBreak",match:"\\n",handler:function(A){insertElement(A.output,"br")}}];Wikifier.textPrimitives={anyDigit:"[0-9]",anyNumberChar:"[0-9\\.E]",urlPattern:"(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)"};Wikifier.createInternalLink=function(A,C){var B=insertElement(A,"a",C);B.href="javascript:void(0)";if(tale.has(C)){B.className="internalLink"}else{B.className="brokenLink"}B.onclick=function(){state.display(C,B)};if(A){A.appendChild(B)}return B};Wikifier.createExternalLink=function(A,B){var C=insertElement(A,"a");C.href=B;C.className="externalLink";C.target="_blank";if(A){A.appendChild(C)}return C};if(!((new RegExp("[\u0150\u0170]","g")).test("\u0150"))){Wikifier.textPrimitives.upperLetter="[A-Z\u00c0-\u00de]";Wikifier.textPrimitives.lowerLetter="[a-z\u00df-\u00ff_0-9\\-]";Wikifier.textPrimitives.anyLetter="[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-]"}else{Wikifier.textPrimitives.upperLetter="[A-Z\u00c0-\u00de\u0150\u0170]";Wikifier.textPrimitives.lowerLetter="[a-z\u00df-\u00ff_0-9\\-\u0151\u0171]";Wikifier.textPrimitives.anyLetter="[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-\u0150\u0170\u0151\u0171]"};